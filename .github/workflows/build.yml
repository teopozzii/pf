name: Build and Release

on:
  push:
    tags:
      - 'v*' # Triggers only when pushing a tag like v1.0, v0.1

permissions:
  contents: write # Required to create releases

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact_name: BankStatementApp.exe
            asset_name: BankStatementApp-Windows.exe
          - os: macos-latest
            artifact_name: dist/BankStatementApp
            asset_name: BankStatementApp-MacOS

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build with PyInstaller
        # Windows command
        if: matrix.os == 'windows-latest'
        run: |
          pyinstaller launcher.py --onefile --windowed --name BankStatementApp --add-data "assets;assets" --add-data "pages;pages" --add-data "utils;utils" --hidden-import dash_pages --hidden-import dash_bootstrap_components --hidden-import plotly.io._renderers

      - name: Build with PyInstaller
        # MacOS command (separator is ':' instead of ';')
        if: matrix.os == 'macos-latest'
        run: |
          pyinstaller launcher.py --onefile --windowed --name BankStatementApp --add-data "assets:assets" --add-data "pages:pages" --add-data "utils:utils" --hidden-import dash_pages --hidden-import dash_bootstrap_components --hidden-import plotly.io._renderers

      - name: Rename Artifact (for clear Release filenames)
        # Windows: Move form dist/BankStatementApp.exe to proper name
        if: matrix.os == 'windows-latest'
        run: move dist/BankStatementApp.exe ${{ matrix.asset_name }}

      - name: Rename Artifact (MacOS)
        # MacOS: Move binary (no extension) to proper name
        if: matrix.os == 'macos-latest'
        run: mv dist/BankStatementApp ${{ matrix.asset_name }}

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ matrix.asset_name }}
